import React, {
  createContext,
  Dispatch,
  SetStateAction,
  useContext,
  useMemo,
  useState,
} from 'react';
import {
  AlertsSeverityByTime,
  MostAffectedAgents,
  MostCommonCVEs,
  MostCommonCWEs,
  TopAffectedPackagesByCVEs,
} from 'modules/Vulnerability/components';
import {
  IVulnerabilityWidgets,
  VulnerabilityWidgetsDefaultConfig,
} from 'modules/Vulnerability/interfaces/Widgets';
import {
  IAlertsSeverityByTime,
  IMostAffectedAgents,
  IMostCommonCVEs,
  IMostCommonCWEs,
  ITopAffectedPackagesByCVEs,
} from 'modules/Vulnerability/interfaces';

export const vulnerabilityWidgets: IVulnerabilityWidgets = {
  alertsSeverityByTime: {
    ...VulnerabilityWidgetsDefaultConfig.alertsSeverityByTime,
    builder: () => <AlertsSeverityByTime />,
  },
  mostAffectedAgents: {
    ...VulnerabilityWidgetsDefaultConfig.mostAffectedAgents,
    builder: () => <MostAffectedAgents />,
  },
  mostCommonCVEs: {
    ...VulnerabilityWidgetsDefaultConfig.mostCommonCVEs,
    builder: () => <MostCommonCVEs />,
  },
  mostCommonCWEs: {
    ...VulnerabilityWidgetsDefaultConfig.mostCommonCWEs,
    builder: () => <MostCommonCWEs />,
  },
  topAffectedPackagesByCVEs: {
    ...VulnerabilityWidgetsDefaultConfig.topAffectedPackagesByCVEs,
    builder: () => <TopAffectedPackagesByCVEs />,
  },
};

interface VulnerabilityContextInterface {
  alertsSeverityByTime: IAlertsSeverityByTime | undefined;
  mostAffectedAgents: IMostAffectedAgents | undefined;
  mostCommonCVEs: IMostCommonCVEs | undefined;
  mostCommonCWEs: IMostCommonCWEs | undefined;
  topAffectedPackagesByCVEs: ITopAffectedPackagesByCVEs | undefined;
  widgetsHandlersMap: { [key: string]: Dispatch<SetStateAction<any>> };
}

const vulnerabilityContextDefaultValues = {
  alertsSeverityByTime: undefined,
  mostAffectedAgents: undefined,
  mostCommonCVEs: undefined,
  mostCommonCWEs: undefined,
  topAffectedPackagesByCVEs: undefined,
  widgetsHandlersMap: {},
};

const VulnerabilityContext = createContext<VulnerabilityContextInterface>(
  vulnerabilityContextDefaultValues
);

export const VulnerabilityProvider: React.FC = ({ children }) => {
  const [alertsSeverityByTime, setAlertsSeverityByTime] = useState<
    IAlertsSeverityByTime | undefined
  >();
  const [mostAffectedAgents, setMostAffectedAgents] = useState<
    IMostAffectedAgents | undefined
  >();
  const [mostCommonCVEs, setMostCommonCVEs] = useState<
    IMostCommonCVEs | undefined
  >();
  const [mostCommonCWEs, setMostCommonCWEs] = useState<
    IMostCommonCWEs | undefined
  >();
  const [topAffectedPackagesByCVEs, setTopAffectedPackagesByCVEs] = useState<
    ITopAffectedPackagesByCVEs | undefined
  >();

  const widgetsHandlersMap = {
    alertsSeverityByTime: setAlertsSeverityByTime,
    mostAffectedAgents: setMostAffectedAgents,
    mostCommonCVEs: setMostCommonCVEs,
    mostCommonCWEs: setMostCommonCWEs,
    topAffectedPackagesByCVEs: setTopAffectedPackagesByCVEs,
  };

  const value = useMemo(
    () => ({
      alertsSeverityByTime,
      mostAffectedAgents,
      mostCommonCVEs,
      mostCommonCWEs,
      topAffectedPackagesByCVEs,
      widgetsHandlersMap,
    }),
    [
      alertsSeverityByTime,
      mostAffectedAgents,
      mostCommonCVEs,
      mostCommonCWEs,
      topAffectedPackagesByCVEs,
    ]
  );

  return (
    <VulnerabilityContext.Provider value={value}>
      {children}
    </VulnerabilityContext.Provider>
  );
};

export const useVulnerability = () => useContext(VulnerabilityContext);
